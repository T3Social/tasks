/*
 * @link https://www.humhub.org/
 * @copyright Copyright (c) 2017 HumHub GmbH & Co. KG
 * @license https://www.humhub.com/licences
 *
 */
humhub.module("task",(function(t,o,i){var n=o("ui.modal"),a=o("client"),c=o("ui.widget.Widget"),s=o("util.object"),r=o("event"),l=o("action"),d=o("ui.loader"),f=function(t,e){c.call(this,t,e)};s.inherits(f,c),f.prototype.init=function(){this.initTimeInput(),this.initScheduling(),this.initAddTaskItem()},f.prototype.initTimeInput=function(t){n.global.$.find(".timeField").find(".form-control").each((function(){var t=i(this);t.prop("disabled")&&t.data("oldVal",t.val()).val("")}))},f.prototype.initScheduling=function(t){var e=n.global.$.find(".tab-scheduling"),o=n.global.$.find("#task-scheduling"),a=n.global.$.find(".field-task-cal_mode");o.prop("checked")?(e.show(),a.show()):(e.hide(),a.hide());var c=i("#taskform-start_date"),s=i("#taskform-end_date");s.on("change",(function(){c.val()||c.val(s.val())})),c.on("change",(function(){s.val()||s.val(c.val())}))},f.prototype.toggleScheduling=function(t){var e=n.global.$.find(".tab-scheduling"),o=n.global.$.find(".field-task-cal_mode");t.$trigger.prop("checked")?(e.show(),o.show()):(e.hide(),o.hide())},f.prototype.toggleDateTime=function(t){var e=n.global.$.find(".timeField"),o=e.find(".form-control");t.$trigger.prop("checked")?(o.prop("disabled",!0),o.each((function(){i(this).data("oldVal",i(this).val()).val("")})),e.css("opacity","0.2")):(o.each((function(){$this=i(this),$this.data("oldVal")&&$this.val($this.data("oldVal"))})),o.prop("disabled",!1),e.css("opacity","1.0"))},f.prototype.removeTaskItem=function(t){t.$trigger.closest(".form-group").remove()},f.prototype.initAddTaskItem=function(){var t=this.$;i(document).on("keypress",'input[name="TaskForm[newItems][]"]',(function(e){13===e.keyCode&&(e.preventDefault(),i(this).data("task-item-added")?i(this).closest(".form-group").next().find("input").focus():(t.find("[data-action-click=addTaskItem]").trigger("click"),i(this).data("task-item-added",!0)))}))},f.prototype.addTaskItem=function(t){var e=t.$trigger;e.prev("input").tooltip({html:!0,container:"body"});var o=e.closest(".form-group").clone(!1);o.find("input").val(""),o.hide(),e.closest(".form-group").after(o),e.children("span").removeClass("glyphicon-plus").addClass("glyphicon-trash"),e.off("click.humhub-action").on("click",(function(){e.closest(".form-group").remove()})),e.removeAttr("data-action-click"),o.fadeIn("fast"),o.find("input").focus()};t.export({init:function(){i(document).on("click",".task-change-state-button a",(function(){d.initLoaderButton(i(".task-change-state-button").children().first()[0])})),r.on("humhub:content:afterMove.tasks",(function(t,e){if(i("#task-space-menu").length){var o=i('[data-content-id="'+e.id+'"]');o.length?o.remove():i("#task-space-menu").find("a:first").click()}}))},Form:f,deleteTask:function(e){var o=c.closest(e.$trigger);o.$.fadeOut("fast"),a.post(e).then((function(){n.global.close(),o&&o.$.remove(),r.trigger("task.afterDelete")})).catch((function(e){o.$.fadeIn("fast"),t.log.error(e,!0)}))},changeState:function(o){o.block=l.BLOCK_MANUAL;var i=c.closest(o.$target);i&&i.changeState?i.changeState(o):a.post(o).then((function(o){o.success?a.reload():t.log.error(e,!0)})).catch((function(e){t.log.error(e,!0),o.finish()}))},extensionrequest:function(o){o.block=l.BLOCK_MANUAL,a.post(o).then((function(i){if(i.success){var n=c.closest(o.$trigger);n.reload().then((function(){n.hide(),t.log.success("request sent")}))}else t.log.error(e,!0),o.finish()})).catch((function(e){t.log.error(e,!0),o.finish()}))}})}));
